# Репозиторий для управления инфраструктурой и приложениями (GitOps)

Этот репозиторий является единым источником правды для всей нашей инфраструктуры и конфигурации приложений. Все изменения версионируются и применяются автоматически, следуя принципам Infrastructure as Code (IaC) и GitOps.

##  guiding principles

*   **Git как единый источник правды**: Вся декларативная конфигурация для инфраструктуры и приложений находится в этом репозитории.
*   **Разделение ответственности**: Структура репозитория разделяет подготовку инфраструктуры (`/infrastructure`), развертывание приложений (`/gitops`) и логику CI/CD (`/ci-templates`).
*   **Автоматизация**: Изменения применяются автоматически с помощью таких инструментов, как Ansible и ArgoCD.

## Directory structure

*   `./infrastructure/`: Код для подготовки и настройки базовой инфраструктуры (кластеры Kubernetes, виртуальные машины, сети).
    *   `ansible/`: Плейбуки и роли Ansible для настройки серверов и установки программного обеспечения.
    *   `terraform/`: (Рекомендуется) Код Terraform для управления облачными ресурсами.
*   `./gitops/`: Декларативные конфигурации для всего, что работает *в* Kubernetes. Это источник правды для ArgoCD.
    *   `bootstrap/`: Начальная настройка ArgoCD, включая паттерн "App of Apps".
    *   `apps/`: Манифесты `Application` ArgoCD, определяющие, какие приложения развертываются в каких средах.
    *   `charts/`: Пользовательские Helm-чарты для наших приложений.
    *   `environments/`: Файлы `values.yaml` для конкретных сред, которые переопределяют значения по умолчанию.
*   `./ci-templates/`: Шаблоны для CI/CD, которые можно переиспользовать в пайплайнах GitLab CI.
*   `./docs/`: Проектная документация, схемы архитектуры и записи о принятых решениях.

## Как использовать этот репозиторий

### Подготовка нового кластера (Infrastructure)

1.  Добавьте IP-адреса новых серверов в соответствующий inventory-файл в `infrastructure/ansible/inventories/`.
2.  Определите переменные для конкретной среды в `infrastructure/ansible/group_vars/`.
3.  Запустите основной плейбук Ansible для подготовки кластера:
    ```bash
    ansible-playbook -i infrastructure/ansible/inventories/dev/hosts.yml infrastructure/ansible/playbooks/01-kubernetes-install.yml
    ```

### Развертывание новой версии приложения (GitOps)

Процесс развертывания полностью автоматизирован через GitOps. Чтобы развернуть новую версию приложения:

1.  **Обновите тег образа**: Измените `image.tag` для вашего сервиса в файле нужного окружения. Например, для развертывания новой версии в `dev`:
    *   Отредактируйте `/gitops/environments/dev/values.yaml`.
    *   Измените `my-app.image.tag` на новую версию.
2.  **Закоммитьте и отправьте изменения**: Сделайте коммит и пуш в ветку `main` (или `develop`).
3.  **Синхронизация ArgoCD**: ArgoCD автоматически обнаружит изменения в Git-репозитории и применит новую конфигурацию к кластеру Kubernetes. Новая версия приложения будет развернута.

### Добавление нового приложения

1.  **Создайте Helm-чарт**: При необходимости создайте новый Helm-чарт для вашего приложения в `/gitops/charts/`.
2.  **Добавьте значения по умолчанию**: Добавьте конфигурацию приложения по умолчанию в `/gitops/environments/base/values.yaml`.
3.  **Создайте манифест приложения ArgoCD**: Создайте новый файл, например, `/gitops/apps/dev/my-new-app.yaml`. Этот файл сообщает ArgoCD, где найти чарт и значения для `dev`-окружения.
4.  **Закоммитьте и отправьте изменения**: ArgoCD обнаружит новый манифест `Application` и развернет ваше приложение в первый раз.

### Использование шаблонов CI/CD

В `.gitlab-ci.yml` вашего приложения подключите необходимые шаблоны из этого репозитория:

```yaml
include:
  - project: 'path/to/this/infra-repo'
    ref: main
    file: '/ci-templates/.build.yml'
```

Это гарантирует, что все проекты используют стандартизированную логику сборки и развертывания.